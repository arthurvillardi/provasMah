<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Questões Aprimorado - Padrão ENARE</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        /* Custom styles for checked radio button labels */
        .option-item input[type="radio"]:checked + label {
            border-color: #3b82f6; /* blue-500 */
            background-color: #1e3a8a; /* blue-900 */
            color: #ffffff;
            font-weight: 600;
        }
        /* Style for correct answer highlight */
        .correct-answer-highlight {
            border-color: #22c55e !important; /* green-500 */
            background-color: #166534 !important; /* green-800 */
            color: #ffffff !important;
        }
        /* Style for incorrect answer highlight */
        .incorrect-answer-highlight {
            border-color: #ef4444 !important; /* red-500 */
            background-color: #991b1b !important; /* red-800 */
            color: #ffffff !important;
        }
        /* Simple spinner for loading state */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

<div class="container max-w-4xl w-full mx-auto">
    <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-blue-400">Gerador de Questões</h1>
        <p class="text-lg text-gray-400">Pratique com questões no padrão ENARE</p>
    </header>

    <div class="bg-gray-800 shadow-2xl rounded-2xl p-6 sm:p-8">
        
        <!-- Controls Section -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <div id="category-filters" class="flex flex-wrap justify-center gap-2">
                <!-- Category buttons will be inserted here -->
            </div>
             <div class="flex items-center gap-2">
                <input type="number" id="question-count-input" value="5" min="1" max="10" class="bg-gray-700 text-white w-20 text-center rounded-lg p-2">
                <button id="generate-pool-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 disabled:bg-blue-800 disabled:cursor-wait">Gerar Simulado</button>
            </div>
        </div>
        
        <div id="quiz-area" class="hidden">
            <!-- Navigation and Score -->
            <div class="flex justify-between items-center mb-4">
                 <button id="prev-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">&lt; Anterior</button>
                 <div class="flex flex-col items-center">
                    <div id="question-counter" class="text-lg font-semibold">Questão 1 / 5</div>
                    <div id="score-container" class="text-sm text-gray-400">Pontuação: 0 / 0</div>
                 </div>
                 <button id="next-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">Próxima &gt;</button>
            </div>

            <!-- Question Container -->
            <div class="question-container min-h-[200px] border-t border-gray-700 pt-4">
                <p class="question-statement text-xl font-medium mb-6" id="question-text"></p>
                <div id="loader-container" class="hidden text-center">
                     <div class="loader"></div>
                     <p>Gerando seu simulado com IA... Isso pode levar alguns segundos.</p>
                </div>
                <div class="options-list space-y-3" id="options-container">
                    <!-- Options will be dynamically generated here -->
                </div>
                
                <div class="mt-6 flex justify-center">
                    <button id="check-btn" class="w-full max-w-xs bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">Verificar Resposta</button>
                </div>

                <div id="feedback" class="feedback-section mt-6 p-5 rounded-lg border-l-4" style="display: none;">
                    <div class="explanation-content">
                        <p class="explanation-title text-xl font-bold mb-2">Gabarito e Explicação</p>
                        <p id="correct-answer-text" class="mb-2 font-semibold"></p>
                        <p id="correct-explanation-text" class="text-gray-300"></p>
                        <div id="incorrect-explanations" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let questionPool = [];
    let userAnswers = []; // Array to store answers for the pool
    let currentIndex = 0;
    let score = { correct: 0, total: 0 };
    let currentFilter = 'Todas';

    const questionTextEl = document.getElementById('question-text');
    const optionsContainerEl = document.getElementById('options-container');
    const feedbackEl = document.getElementById('feedback');
    const checkBtn = document.getElementById('check-btn');
    const generatePoolBtn = document.getElementById('generate-pool-btn');
    const scoreContainer = document.getElementById('score-container');
    const categoryFiltersContainer = document.getElementById('category-filters');
    const loaderContainer = document.getElementById('loader-container');
    const quizArea = document.getElementById('quiz-area');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const questionCounter = document.getElementById('question-counter');
    const questionCountInput = document.getElementById('question-count-input');
    
    function setupCategories() {
        const categories = ['Todas', "Clínica Médica", "Cirurgia", "Pediatria", "Ginecologia e Obstetrícia", "Medicina Preventiva"];
        categoryFiltersContainer.innerHTML = '';
        categories.forEach(category => {
            const button = document.createElement('button');
            button.textContent = category;
            button.className = `px-3 py-1 rounded-md text-sm font-medium transition ${category === currentFilter ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600'}`;
            button.onclick = () => {
                currentFilter = category;
                document.querySelectorAll('#category-filters button').forEach(btn => {
                    btn.className = `px-3 py-1 rounded-md text-sm font-medium transition ${btn.textContent === currentFilter ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600'}`;
                });
            };
            categoryFiltersContainer.appendChild(button);
        });
    }

    function showLoading(isLoading) {
        if (isLoading) {
            quizArea.classList.add('hidden');
            loaderContainer.classList.remove('hidden');
            generatePoolBtn.disabled = true;
            generatePoolBtn.textContent = 'Gerando...';
        } else {
            loaderContainer.classList.add('hidden');
            quizArea.classList.remove('hidden');
            generatePoolBtn.disabled = false;
            generatePoolBtn.textContent = 'Gerar Simulado';
        }
    }
    
    async function fetchQuestionPoolFromAI(category, count) {
        showLoading(true);
        const categoryPrompt = category === 'Todas' ? 'uma das grandes áreas da medicina (Clínica Médica, Cirurgia, Pediatria, G.O. ou Preventiva)' : category;
        const systemPrompt = `Você é um especialista em educação médica, criando questões para o Exame Nacional de Residência Médica (ENARE) no Brasil. Sua tarefa é gerar um bloco de questões complexas e de alta qualidade.`;
        const userQuery = `Crie um bloco de ${count} questões de múltipla escolha (A, B, C, D) sobre ${categoryPrompt}. Para cada questão, inclua:
1.  Um caso clínico detalhado e realista.
2.  Quatro opções de resposta (A, B, C, D), todas plausíveis.
3.  Indicação da alternativa correta.
4.  Uma explicação detalhada para a alternativa correta.
5.  Explicações concisas para CADA uma das três alternativas incorretas.
A resposta DEVE ser um array de objetos JSON, sem nenhum texto ou formatação adicional.`;

        const apiKey = ""; // API key is handled by the environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: { "category": { "type": "STRING" }, "statement": { "type": "STRING" },
                            "options": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "id": { "type": "STRING" }, "text": { "type": "STRING" } }, "required": ["id", "text"]}},
                            "correctAnswer": { "type": "STRING" },
                            "explanation": { "type": "OBJECT", "properties": { "correct": { "type": "STRING" }, "incorrects": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "id": { "type": "STRING" }, "reason": { "type": "STRING" }},"required": ["id", "reason"]}}},"required": ["correct", "incorrects"]}},
                        "required": ["category", "statement", "options", "correctAnswer", "explanation"]
                    }
                }
            }
        };

        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API error: ${response.statusText}`);
            const result = await response.json();
            const jsonText = result.candidates[0].content.parts[0].text;
            questionPool = JSON.parse(jsonText);
            startQuiz();
        } catch (error) {
            console.error("Error fetching AI question pool:", error);
            alert("Ocorreu um erro ao gerar o simulado. Por favor, tente novamente.");
        } finally {
            showLoading(false);
        }
    }
    
    function startQuiz() {
        currentIndex = 0;
        userAnswers = new Array(questionPool.length).fill(null);
        score = { correct: 0, total: 0 };
        displayCurrentQuestion();
        updateScore();
    }
    
    function displayCurrentQuestion() {
        if (questionPool.length === 0) return;
        const question = questionPool[currentIndex];
        
        questionTextEl.textContent = question.statement;
        optionsContainerEl.innerHTML = '';
        feedbackEl.style.display = 'none';

        question.options.forEach(option => {
            const div = document.createElement('div');
            div.className = 'option-item';
            div.innerHTML = `
                <input type="radio" id="option${option.id}" name="question" value="${option.id}" class="hidden">
                <label for="option${option.id}" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer hover:bg-gray-700 hover:border-blue-500 transition">${option.id}) ${option.text}</label>
            `;
            optionsContainerEl.appendChild(div);
        });
        
        updateNavigation();
        restoreAnswerState();
    }
    
    function restoreAnswerState() {
        const savedAnswer = userAnswers[currentIndex];
        if (savedAnswer) {
            document.querySelector(`input[name="question"][value="${savedAnswer.selected}"]`).checked = true;
            showFeedback(savedAnswer.isCorrect);
            checkBtn.disabled = true;
        } else {
            checkBtn.disabled = false;
        }
    }
    
    function showFeedback(isCorrect) {
        const question = questionPool[currentIndex];
        
        feedbackEl.style.display = 'block';
        feedbackEl.className = `feedback-section mt-6 p-5 rounded-lg border-l-4 ${isCorrect ? 'border-green-500 bg-green-900/50' : 'border-red-500 bg-red-900/50'}`;

        document.querySelectorAll('input[name="question"]').forEach(input => {
            const label = input.nextElementSibling;
            if (input.value === question.correctAnswer) {
                label.classList.add('correct-answer-highlight');
            } else if (input.checked) {
                label.classList.add('incorrect-answer-highlight');
            }
        });
        
        const correctAnswerText = document.getElementById('correct-answer-text');
        const correctExplanationText = document.getElementById('correct-explanation-text');
        const incorrectExplanationsContainer = document.getElementById('incorrect-explanations');

        correctAnswerText.innerHTML = `<span class="text-green-400">Alternativa Correta: ${question.correctAnswer}</span>`;
        correctExplanationText.textContent = question.explanation.correct;
        
        if (!isCorrect) {
            let incorrectHtml = `<p class="explanation-title text-lg font-bold mt-4 mb-2 text-red-400">Análise das Alternativas Incorretas:</p>`;
            question.explanation.incorrects.forEach(inc => {
                incorrectHtml += `<p class="mb-2"><b class="text-gray-200">${inc.id})</b> <span class="text-gray-400">${inc.reason}</span></p>`;
            });
            incorrectExplanationsContainer.innerHTML = incorrectHtml;
        } else {
            incorrectExplanationsContainer.innerHTML = '';
        }
    }

    function checkAnswer() {
        const selectedOption = document.querySelector('input[name="question"]:checked');
        if (!selectedOption) {
            alert('Por favor, selecione uma alternativa.');
            return;
        }

        const userAnswer = selectedOption.value;
        const question = questionPool[currentIndex];
        const isCorrect = userAnswer === question.correctAnswer;
        
        if (userAnswers[currentIndex] === null) {
            score.total++;
            if (isCorrect) score.correct++;
        }
        
        userAnswers[currentIndex] = { selected: userAnswer, isCorrect: isCorrect };
        
        updateScore();
        showFeedback(isCorrect);
        checkBtn.disabled = true;
    }

    function updateNavigation() {
        questionCounter.textContent = `Questão ${currentIndex + 1} / ${questionPool.length}`;
        prevBtn.disabled = currentIndex === 0;
        nextBtn.disabled = currentIndex === questionPool.length - 1;
    }
    
    function updateScore() {
        scoreContainer.textContent = `Pontuação: ${score.correct} / ${score.total}`;
    }
    
    // EVENT LISTENERS
    generatePoolBtn.addEventListener('click', () => {
        const count = parseInt(questionCountInput.value, 10);
        if (count > 0 && count <= 10) {
            fetchQuestionPoolFromAI(currentFilter, count);
        } else {
            alert("Por favor, insira um número de questões entre 1 e 10.");
        }
    });
    
    checkBtn.addEventListener('click', checkAnswer);
    
    prevBtn.addEventListener('click', () => {
        if (currentIndex > 0) {
            currentIndex--;
            displayCurrentQuestion();
        }
    });

    nextBtn.addEventListener('click', () => {
        if (currentIndex < questionPool.length - 1) {
            currentIndex++;
            displayCurrentQuestion();
        }
    });
    
    // INITIAL SETUP
    setupCategories();
});
</script>

</body>
</html>

